<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bills Tracker</title>
  <style>
    :root{
      --bg:#12121a; /* softened */
      --card:#171722;
      --card2:#1f1f2c;
      --text:#f4f4f7;
      --muted:#b7b7c8;
      --purple:#b58ce8;
      --purple2:#6f4bb8;
      --danger:#ff5c6c;
      --ok:#2bd576;
      --line:rgba(255,255,255,0.08);
      --accentSoft: rgba(255,255,255,0.12); /* new */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 30% -20%, rgba(181,140,232,0.22), transparent 55%),
        radial-gradient(900px 500px at 90% 0%, rgba(111,75,184,0.20), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .app{max-width:520px;margin:0 auto;padding:18px 14px 22px}
    .top{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;margin-bottom:10px}
    .titleWrap{display:flex;flex-direction:column;gap:4px}
    .title{font-size:20px;font-weight:800;letter-spacing:0.2px;line-height:1.1}
    .slogan{font-size:12px;color:var(--muted);font-style:italic}
    .meta{font-size:12px;color:var(--muted);margin-top:2px}
    .iconBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      width:44px;height:44px;
      border-radius: 14px;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
    }
    .iconBtn:active{transform:scale(0.99)}
    .monthRow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform: scale(0.99)}
    .btnPurple{
      border:1px solid rgba(181,140,232,0.45);
      background: rgba(181,140,232,0.18);
    }
    select,input,textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px}
    .stat{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
    }
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-size:16px;font-weight:900;margin-top:4px}
    .seg{
      display:flex;gap:8px;
      background: rgba(255,255,255,0.04);
      border:1px solid var(--line);
      border-radius:14px;
      padding:6px;
      margin:12px 0;
    }
    .seg button{
      flex:1;
      padding:10px 10px;
      border-radius:12px;
      border:0;
      background:transparent;
      color: var(--muted);
      font-weight:900;
      cursor:pointer;
    }
    .seg button.active{
      background: rgba(181,140,232,0.20);
      color: var(--text);
      border:1px solid rgba(181,140,232,0.32);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin-bottom:10px;
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{
      font-size:12px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      background: rgba(181,140,232,0.14); /* reduced */
      border:1px solid rgba(181,140,232,0.30);
      color:var(--text);
      white-space:nowrap;
    }
    .pillSoft{
      background: var(--accentSoft);
      border:1px solid rgba(255,255,255,0.10);
      color: var(--text);
    }
    .muted{color:var(--muted)}
    .big{font-size:16px;font-weight:900}
    .small{font-size:12px}
    .dueSoon{
      border-color: rgba(181,140,232,0.50);
      background: linear-gradient(180deg, rgba(181,140,232,0.14), rgba(255,255,255,0.03));
    }
    .overdue{
      border-color: rgba(255,92,108,0.55);
      background: linear-gradient(180deg, rgba(255,92,108,0.16), rgba(255,255,255,0.03));
    }
    .paidFade{opacity:0.72}
    .toggle{display:flex;gap:10px;align-items:center;justify-content:flex-end;white-space:nowrap}
    .checkbox{width:22px;height:22px;accent-color: var(--purple)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .dangerBtn{border:1px solid rgba(255,92,108,0.45);background: rgba(255,92,108,0.16)}
    .okBtn{border:1px solid rgba(43,213,118,0.45);background: rgba(43,213,118,0.14)}
    .hr{height:1px;background: var(--line);margin:10px 0}
    a{color:var(--purple);text-decoration:none}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="titleWrap">
        <div class="title">Bills Tracker</div>
        <div class="slogan">Because forgetting costs money</div>
        <div class="meta" id="metaLine"></div>
      </div>
      <button class="iconBtn" id="btnSettings" aria-label="Settings" title="Settings">
        <!-- simple cog -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/>
          <path d="M19.4 15a8.2 8.2 0 0 0 .1-1l2-1.2-2-3.4-2.3.7a7.5 7.5 0 0 0-1.7-1l-.3-2.4H11l-.3 2.4a7.5 7.5 0 0 0-1.7 1l-2.3-.7-2 3.4 2 1.2a8.2 8.2 0 0 0 0 2l-2 1.2 2 3.4 2.3-.7a7.5 7.5 0 0 0 1.7 1L11 23h4l.3-2.4a7.5 7.5 0 0 0 1.7-1l2.3.7 2-3.4-2-1.2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="monthRow">
      <button class="btn" id="prevMonth">◀︎</button>
      <select id="monthSelect" aria-label="Month selector"></select>
      <button class="btn" id="nextMonth">▶︎</button>
    </div>

    <div class="stats">
      <div class="stat"><div class="k">Total due</div><div class="v" id="statDue">$0.00</div></div>
      <div class="stat"><div class="k">Paid</div><div class="v" id="statPaid">$0.00</div></div>
      <div class="stat"><div class="k">Unpaid</div><div class="v" id="statUnpaid">$0.00</div></div>
    </div>

    <div class="seg">
      <button id="tabTracker" class="active">Tracker</button>
      <button id="tabBills">Bills</button>
      <button id="tabHistory">History</button>
    </div>

    <div id="viewTracker"></div>
    <div id="viewBills" style="display:none;"></div>
    <div id="viewHistory" style="display:none;"></div>
    <div id="viewSettings" style="display:none;"></div>
  </div>

<script>
(function(){
  const APP_VERSION = "v1.3";
  const RELEASE_DATE = "2025-12-16";
  const DEVELOPER = "Manny Ch.";
  const STORAGE_KEY = "billTrackerV1";
  const SCHEMA_VERSION = 3;

  const today = () => {
    const d = new Date();
    d.setHours(0,0,0,0);
    return d;
  };

  const fmtMoney = (n) => new Intl.NumberFormat(undefined,{style:"currency",currency:"USD"}).format(Number(n||0));
  const pad2 = (n) => String(n).padStart(2,"0");
  const toISODate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

  const monthKeyFromDate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  const monthLabelFromKey = (key) => {
    const [y,m] = key.split("-").map(Number);
    const dt = new Date(y, m-1, 1);
    return dt.toLocaleString(undefined,{month:"short",year:"numeric"});
  };
  const addMonths = (d, delta) => {
    const dt = new Date(d.getFullYear(), d.getMonth()+delta, 1);
    dt.setHours(0,0,0,0);
    return dt;
  };
  const firstOfMonthFromKey = (key) => {
    const [y,m] = key.split("-").map(Number);
    const dt = new Date(y, m-1, 1);
    dt.setHours(0,0,0,0);
    return dt;
  };
  const computeDueDate = (monthKey, dueDay) => {
    const base = firstOfMonthFromKey(monthKey);
    const y = base.getFullYear();
    const m = base.getMonth();
    const lastDay = new Date(y, m+1, 0).getDate();
    const day = Math.min(Number(dueDay), lastDay);
    const dt = new Date(y, m, day);
    dt.setHours(0,0,0,0);
    return dt;
  };
  const daysBetween = (a,b) => Math.floor((b.getTime()-a.getTime())/(24*60*60*1000));
  const uid = () => Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,10);

  function defaultData(){
    return {
      schemaVersion: SCHEMA_VERSION,
      bills: [],   // blank template by default
      payments: {},// key: `${monthKey}|${billId}` -> { paidAtISO, dueISO, amount }
      notes: {}    // key: `${monthKey}|${billId}` -> month note
    };
  }

  function migrateData(data){
    // Ensure structure exists
    if(!data || !Array.isArray(data.bills)) return defaultData();
    data.payments ||= {};
    data.notes ||= {};

    // Schema version bump
    if(!Number.isFinite(data.schemaVersion)) data.schemaVersion = 1;

    // Backfill new fields on each bill
    data.bills.forEach(b => {
      // existing fields
      if(b.active === undefined) b.active = true;
      if(b.calendarExported === undefined) b.calendarExported = false;

      // v1.3 fields
      if(b.nickname === undefined) b.nickname = "";
      if(b.url === undefined) b.url = "";
      if(b.autopay === undefined) b.autopay = false;
      if(b.payMethod === undefined) b.payMethod = "";
      if(b.billNotes === undefined) b.billNotes = "";
      if(b.variableAmount === undefined) b.variableAmount = false;
    });

    data.schemaVersion = SCHEMA_VERSION;
    return data;
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultData();
      return migrateData(JSON.parse(raw));
    }catch(e){
      return defaultData();
    }
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data)); }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

  function downloadTextFile(filename, content, mime){
    const blob = new Blob([content], {type: mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
  }
  function icsEscape(s){
    return String(s ?? "")
      .replace(/\\/g, "\\\\")
      .replace(/\n/g, "\\n")
      .replace(/,/g, "\\,")
      .replace(/;/g, "\\;");
  }
  function formatICSDateTimeLocal(d){
    const y=d.getFullYear(), m=pad2(d.getMonth()+1), day=pad2(d.getDate());
    const hh=pad2(d.getHours()), mm=pad2(d.getMinutes()), ss=pad2(d.getSeconds());
    return `${y}${m}${day}T${hh}${mm}${ss}`;
  }

  const state = {
    data: load(),
    monthKey: monthKeyFromDate(today()),
    activeTab: "tracker",
  };

  const el = {
    metaLine: document.getElementById("metaLine"),
    monthSelect: document.getElementById("monthSelect"),
    prevMonth: document.getElementById("prevMonth"),
    nextMonth: document.getElementById("nextMonth"),
    statDue: document.getElementById("statDue"),
    statPaid: document.getElementById("statPaid"),
    statUnpaid: document.getElementById("statUnpaid"),
    tabTracker: document.getElementById("tabTracker"),
    tabBills: document.getElementById("tabBills"),
    tabHistory: document.getElementById("tabHistory"),
    viewTracker: document.getElementById("viewTracker"),
    viewBills: document.getElementById("viewBills"),
    viewHistory: document.getElementById("viewHistory"),
    viewSettings: document.getElementById("viewSettings"),
    btnSettings: document.getElementById("btnSettings"),
  };

  function setMetaLine(){
    const now = new Date();
    const monthYear = now.toLocaleString(undefined,{month:"long",year:"numeric"});
    el.metaLine.textContent = `${monthYear} • ${APP_VERSION} • Released ${RELEASE_DATE} • Developer ${DEVELOPER}`;
  }

  function monthOptions(){
    const now = today();
    const start = addMonths(new Date(now.getFullYear(), now.getMonth(), 1), -12);
    const end = addMonths(new Date(now.getFullYear(), now.getMonth(), 1), 18);
    const keys = [];
    let cur = new Date(start);
    while(cur <= end){
      keys.push(monthKeyFromDate(cur));
      cur = addMonths(cur, 1);
    }
    return keys;
  }
  function renderMonthSelect(){
    const keys = monthOptions();
    el.monthSelect.innerHTML = keys.map(k => `<option value="${k}">${monthLabelFromKey(k)}</option>`).join("");
    el.monthSelect.value = state.monthKey;
  }

  function getInstanceKey(monthKey, billId){ return `${monthKey}|${billId}`; }
  function isPaid(monthKey, billId){ return Boolean(state.data.payments[getInstanceKey(monthKey,billId)]); }
  function paidInfo(monthKey, billId){ return state.data.payments[getInstanceKey(monthKey,billId)] || null; }

  function setPaid(monthKey, bill){
    const k = getInstanceKey(monthKey, bill.id);
    const due = computeDueDate(monthKey, bill.dueDay);
    state.data.payments[k] = { paidAtISO: toISODate(today()), dueISO: toISODate(due), amount: Number(bill.amount||0) };
    save();
  }
  function setUnpaid(monthKey, billId){
    delete state.data.payments[getInstanceKey(monthKey,billId)];
    save();
  }

  function getNote(monthKey, billId){ return state.data.notes[getInstanceKey(monthKey,billId)] || ""; }
  function setNote(monthKey, billId, text){
    const k = getInstanceKey(monthKey,billId);
    if(text && text.trim()) state.data.notes[k] = text.trim();
    else delete state.data.notes[k];
    save();
  }

  function activeBills(){ return state.data.bills.filter(b => b.active !== false); }

  function buildTrackerRows(){
    const bills = activeBills();
    const rows = bills.map(b => {
      const dueDate = computeDueDate(state.monthKey, b.dueDay);
      const paid = isPaid(state.monthKey, b.id);
      const info = paid ? paidInfo(state.monthKey, b.id) : null;
      return {
        bill: b,
        dueDate,
        dueISO: toISODate(dueDate),
        paid,
        paidAtISO: info ? info.paidAtISO : null,
        note: getNote(state.monthKey, b.id),
      };
    });
    rows.sort((a,b) => a.dueDate - b.dueDate || a.bill.provider.localeCompare(b.bill.provider));
    return rows;
  }

  function updateStats(rows){
    const totalDue = rows.reduce((s,r)=> s + Number(r.bill.amount||0), 0);
    const totalPaid = rows.filter(r=>r.paid).reduce((s,r)=> s + Number(r.bill.amount||0), 0);
    const totalUnpaid = totalDue - totalPaid;
    el.statDue.textContent = fmtMoney(totalDue);
    el.statPaid.textContent = fmtMoney(totalPaid);
    el.statUnpaid.textContent = fmtMoney(totalUnpaid);
  }

  function renderTracker(){
    const rows = buildTrackerRows();
    updateStats(rows);

    const now = today();
    el.viewTracker.innerHTML = rows.length === 0 ? `
      <div class="card">
        <div class="big">No bills yet</div>
        <div class="small muted" style="margin-top:6px;">Go to Bills and tap Add to create your first bill.</div>
      </div>
    ` : rows.map(r => {
      const dueIn = daysBetween(now, r.dueDate);
      const overdue = !r.paid && r.dueDate < now;
      const dueSoon = !r.paid && r.dueDate >= now && dueIn <= 7;

      const cls = ["card", dueSoon?"dueSoon":"", overdue?"overdue":"", r.paid?"paidFade":""].filter(Boolean).join(" ");
      const paidLabel = r.paid ? `Paid ${r.paidAtISO}` : "Unpaid";
      const displayName = (r.bill.nickname && r.bill.nickname.trim()) ? r.bill.nickname.trim() : r.bill.provider;
      const subLineParts = [];
      if(r.bill.autopay) subLineParts.push("Autopay");
      if(r.bill.variableAmount) subLineParts.push("Varies");
      if(r.bill.payMethod && r.bill.payMethod.trim()) subLineParts.push(r.bill.payMethod.trim());
      const subLine = subLineParts.length ? subLineParts.join(" • ") : "";

      const noteLine = r.note ? `<div class="small muted" style="margin-top:6px;">Note: ${escapeHtml(r.note)}</div>` : "";
      const urlBtn = (r.bill.url && r.bill.url.trim()) ? `<button class="btn" data-openurl="${escapeAttr(r.bill.id)}">Open</button>` : "";

      return `
        <div class="${cls}">
          <div class="row">
            <div>
              <div class="small muted">Due ${r.dueISO}</div>
              <div class="big">${escapeHtml(displayName)}</div>
              ${subLine ? `<div class="small muted" style="margin-top:4px;">${escapeHtml(subLine)}</div>` : ``}
            </div>
            <div class="toggle">
              <div style="text-align:right;">
                <div class="big">${fmtMoney(r.bill.amount)}</div>
                <div class="small muted">${paidLabel}</div>
              </div>
              <input class="checkbox" type="checkbox" ${r.paid ? "checked" : ""} data-billid="${escapeAttr(r.bill.id)}" />
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="pill">${escapeHtml(r.bill.category)}</div>
            <div style="display:flex; gap:10px;">
              ${urlBtn}
              <button class="btn" data-note="${escapeAttr(r.bill.id)}">Note</button>
            </div>
          </div>
          ${noteLine}
        </div>
      `;
    }).join("");

    el.viewTracker.querySelectorAll('input[type="checkbox"][data-billid]').forEach(cb => {
      cb.addEventListener("change",(e)=>{
        const billId = e.target.getAttribute("data-billid");
        const bill = state.data.bills.find(b => b.id === billId);
        if(!bill) return;
        if(e.target.checked) setPaid(state.monthKey, bill);
        else setUnpaid(state.monthKey, billId);
        renderAll();
      });
    });

    el.viewTracker.querySelectorAll('button[data-note]').forEach(btn => {
      btn.addEventListener("click",()=>{
        const billId = btn.getAttribute("data-note");
        const current = getNote(state.monthKey, billId);
        const text = prompt("Note for this month and this bill", current);
        if(text === null) return;
        setNote(state.monthKey, billId, text);
        renderAll();
      });
    });

    el.viewTracker.querySelectorAll('button[data-openurl]').forEach(btn => {
      btn.addEventListener("click", ()=>{
        const billId = btn.getAttribute("data-openurl");
        const bill = state.data.bills.find(b=>b.id===billId);
        if(!bill || !bill.url) return;
        const url = bill.url.trim();
        window.open(url, "_blank", "noopener,noreferrer");
      });
    });
  }

  function renderBills(){
    const bills = state.data.bills.slice().sort((a,b)=>
      (a.active===b.active?0:(a.active?-1:1)) || a.provider.localeCompare(b.provider)
    );

    el.viewBills.innerHTML = `
      <div class="card">
        <div class="row">
          <div>
            <div class="big">Bills Master</div>
            <div class="small muted">Add or edit recurring bills</div>
          </div>
          <button class="btn btnPurple" id="addBill">Add</button>
        </div>
      </div>

      ${bills.length===0 ? `
        <div class="card">
          <div class="muted">No bills added yet.</div>
        </div>
      ` : bills.map(b => {
        const displayName = (b.nickname && b.nickname.trim()) ? `${b.nickname.trim()} (${b.provider})` : b.provider;
        const flags = [];
        if(b.autopay) flags.push("Autopay");
        if(b.variableAmount) flags.push("Varies");
        const flagText = flags.length ? ` • ${flags.join(" • ")}` : "";
        return `
          <div class="card">
            <div class="row">
              <div>
                <div class="big">${escapeHtml(displayName)}</div>
                <div class="small muted">${escapeHtml(b.category)} • Due day ${Number(b.dueDay)} • ${fmtMoney(b.amount)}${flagText}</div>
              </div>
              <div class="toggle">
                <label class="small muted">Active</label>
                <input class="checkbox" type="checkbox" ${b.active !== false ? "checked" : ""} data-active="${escapeAttr(b.id)}" />
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <button class="btn" data-edit="${escapeAttr(b.id)}">Edit</button>
              <button class="btn dangerBtn" data-del="${escapeAttr(b.id)}">Delete</button>
            </div>
          </div>
        `;
      }).join("")}
    `;

    document.getElementById("addBill").addEventListener("click", ()=> editBill(null));

    el.viewBills.querySelectorAll('input[type="checkbox"][data-active]').forEach(cb => {
      cb.addEventListener("change",(e)=>{
        const id = e.target.getAttribute("data-active");
        const bill = state.data.bills.find(x=>x.id===id);
        if(!bill) return;
        bill.active = e.target.checked;
        save();
        renderAll();
      });
    });

    el.viewBills.querySelectorAll('button[data-edit]').forEach(btn => {
      btn.addEventListener("click", ()=> editBill(btn.getAttribute("data-edit")));
    });

    el.viewBills.querySelectorAll('button[data-del]').forEach(btn => {
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        const bill = state.data.bills.find(x=>x.id===id);
        if(!bill) return;
        if(confirm(`Delete bill: ${bill.provider}?`)){
          state.data.bills = state.data.bills.filter(x=>x.id!==id);
          for(const k of Object.keys(state.data.payments)) if(k.endsWith("|"+id)) delete state.data.payments[k];
          for(const k of Object.keys(state.data.notes)) if(k.endsWith("|"+id)) delete state.data.notes[k];
          save();
          renderAll();
        }
      });
    });
  }

  function editBill(id){
    const isNew = !id;
    const existing = !isNew ? state.data.bills.find(b=>b.id===id) : null;

    const bill = isNew
      ? {
          id: uid(),
          category:"Subscriptions",
          provider:"",
          nickname:"",
          url:"",
          dueDay:1,
          amount:0,
          autopay:false,
          payMethod:"",
          billNotes:"",
          variableAmount:false,
          active:true
        }
      : JSON.parse(JSON.stringify(existing));

    if(!bill) return;

    el.viewBills.innerHTML = `
      <div class="card">
        <div class="big">${isNew ? "Add bill" : "Edit bill"}</div>
        <div class="hr"></div>

        <div style="display:grid; gap:10px;">
          <div class="grid2">
            <div>
              <div class="small muted" style="margin:0 0 6px;">Provider</div>
              <input id="fProvider" value="${escapeAttr(bill.provider)}" placeholder="Netflix" />
            </div>
            <div>
              <div class="small muted" style="margin:0 0 6px;">Nickname (optional)</div>
              <input id="fNickname" value="${escapeAttr(bill.nickname||"")}" placeholder="Streaming" />
            </div>
          </div>

          <div>
            <div class="small muted" style="margin:0 0 6px;">Provider URL (optional)</div>
            <input id="fUrl" value="${escapeAttr(bill.url||"")}" placeholder="https://..." />
          </div>

          <div class="grid2">
            <div>
              <div class="small muted" style="margin:0 0 6px;">Category</div>
              <input id="fCategory" value="${escapeAttr(bill.category)}" placeholder="Subscriptions" />
            </div>
            <div>
              <div class="small muted" style="margin:0 0 6px;">Due day</div>
              <input id="fDueDay" type="number" min="1" max="31" value="${Number(bill.dueDay)}" />
            </div>
          </div>

          <div class="grid2">
            <div>
              <div class="small muted" style="margin:0 0 6px;">Amount</div>
              <input id="fAmount" type="number" step="0.01" value="${Number(bill.amount)}" />
            </div>
            <div>
              <div class="small muted" style="margin:0 0 6px;">Payment method (optional)</div>
              <input id="fPayMethod" value="${escapeAttr(bill.payMethod||"")}" placeholder="Debit, Credit, ACH..." />
            </div>
          </div>

          <div class="grid2">
            <div class="card" style="margin:0; padding:10px;">
              <div class="row">
                <div>
                  <div class="big">Autopay</div>
                  <div class="small muted">Tracks if this is on autopay</div>
                </div>
                <input id="fAutopay" class="checkbox" type="checkbox" ${bill.autopay ? "checked" : ""} />
              </div>
            </div>

            <div class="card" style="margin:0; padding:10px;">
              <div class="row">
                <div>
                  <div class="big">Amount varies</div>
                  <div class="small muted">For bills that change monthly</div>
                </div>
                <input id="fVaries" class="checkbox" type="checkbox" ${bill.variableAmount ? "checked" : ""} />
              </div>
            </div>
          </div>

          <div>
            <div class="small muted" style="margin:0 0 6px;">Bill notes (optional)</div>
            <textarea id="fBillNotes" placeholder="Account details, login hints, anything you want to remember...">${escapeHtml(bill.billNotes||"")}</textarea>
          </div>

          <div class="grid2">
            <div>
              <div class="small muted" style="margin:0 0 6px;">Active</div>
              <select id="fActive">
                <option value="true" ${bill.active!==false ? "selected":""}>True</option>
                <option value="false" ${bill.active===false ? "selected":""}>False</option>
              </select>
            </div>
            <div class="row" style="justify-content:flex-end;">
              <button class="btn dangerBtn" id="cancelEdit">Cancel</button>
              <button class="btn okBtn" id="saveEdit">Save</button>
            </div>
          </div>
        </div>
      </div>
    `;

    document.getElementById("cancelEdit").addEventListener("click", ()=> renderAll());
    document.getElementById("saveEdit").addEventListener("click", ()=>{
      const provider = document.getElementById("fProvider").value.trim();
      const nickname = document.getElementById("fNickname").value.trim();
      const url = document.getElementById("fUrl").value.trim();
      const category = document.getElementById("fCategory").value.trim();
      const dueDay = Number(document.getElementById("fDueDay").value);
      const amount = Number(document.getElementById("fAmount").value);
      const payMethod = document.getElementById("fPayMethod").value.trim();
      const autopay = document.getElementById("fAutopay").checked;
      const variableAmount = document.getElementById("fVaries").checked;
      const billNotes = document.getElementById("fBillNotes").value.trim();
      const active = document.getElementById("fActive").value === "true";

      if(!provider){ alert("Provider is required."); return; }
      if(!category){ alert("Category is required."); return; }
      if(!Number.isFinite(dueDay) || dueDay < 1 || dueDay > 31){ alert("Due day must be 1 to 31."); return; }
      if(!Number.isFinite(amount) || amount < 0){ alert("Amount must be 0 or more."); return; }
      if(url && !/^https?:\/\//i.test(url)){
        alert("URL should start with http:// or https://");
        return;
      }

      const newBill = {
        ...bill,
        provider,
        nickname,
        url,
        category,
        dueDay,
        amount,
        payMethod,
        autopay,
        variableAmount,
        billNotes,
        active,
        calendarExported: bill.calendarExported === true ? true : false
      };

      if(isNew) state.data.bills.push(newBill);
      else{
        const idx = state.data.bills.findIndex(b=>b.id===id);
        if(idx>=0) state.data.bills[idx] = newBill;
      }

      save();
      renderAll();
    });
  }

  function renderHistory(){
    const items = [];
    for(const k of Object.keys(state.data.payments)){
      const [monthKey, billId] = k.split("|");
      if(monthKey !== state.monthKey) continue;
      const bill = state.data.bills.find(b=>b.id===billId);
      const info = state.data.payments[k];
      if(!bill || !info) continue;
      items.push({ provider: bill.provider, nickname: bill.nickname||"", category: bill.category, amount: info.amount, paidAtISO: info.paidAtISO, dueISO: info.dueISO, billId });
    }
    items.sort((a,b)=> (a.paidAtISO < b.paidAtISO ? 1 : -1) || a.provider.localeCompare(b.provider));

    el.viewHistory.innerHTML = `
      <div class="card">
        <div class="big">History</div>
        <div class="small muted">Paid entries for ${monthLabelFromKey(state.monthKey)}</div>
      </div>

      ${items.length===0 ? `
        <div class="card"><div class="muted">No payments logged for this month yet.</div></div>
      ` : items.map(it => {
        const name = (it.nickname && it.nickname.trim()) ? `${it.nickname.trim()} (${it.provider})` : it.provider;
        return `
          <div class="card">
            <div class="row">
              <div>
                <div class="small muted">Paid ${it.paidAtISO}</div>
                <div class="big">${escapeHtml(name)}</div>
                <div class="small muted">For due date ${it.dueISO}</div>
              </div>
              <div style="text-align:right;">
                <div class="big">${fmtMoney(it.amount)}</div>
                <div class="pill">${escapeHtml(it.category)}</div>
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <button class="btn dangerBtn" data-undo="${escapeAttr(it.billId)}">Undo</button>
            </div>
          </div>
        `;
      }).join("")}
    `;

    el.viewHistory.querySelectorAll('button[data-undo]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const billId = btn.getAttribute("data-undo");
        if(confirm("Mark unpaid for this month?")){
          setUnpaid(state.monthKey, billId);
          renderAll();
        }
      });
    });
  }

  function exportBillsToCalendar(){
    const bills = activeBills().filter(b => !b.calendarExported);
    if(bills.length === 0){ alert("No active bills to export."); return; }

    const startMonth = firstOfMonthFromKey(state.monthKey);
    const reminderHour = 9;
    const reminderMinute = 0;
    const alarmMinutesBefore = 24 * 60;

    const lines = [];
    lines.push("BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BillsTracker//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH");

    bills.forEach(b=>{
      const due = computeDueDate(monthKeyFromDate(startMonth), b.dueDay);
      const dt = new Date(due.getFullYear(), due.getMonth(), due.getDate(), reminderHour, reminderMinute, 0);
      const dtStart = formatICSDateTimeLocal(dt);
      const dtEnd = formatICSDateTimeLocal(new Date(dt.getTime() + 30*60000));

      const uidStr = `${b.id}@billstracker`;
      const titleName = (b.nickname && b.nickname.trim()) ? b.nickname.trim() : b.provider;
      const summary = `${titleName} due`;
      const desc = `${b.category}. Amount: ${fmtMoney(b.amount)}. Due day: ${b.dueDay}.`;

      lines.push("BEGIN:VEVENT");
      lines.push(`UID:${icsEscape(uidStr)}`);
      lines.push(`DTSTAMP:${formatICSDateTimeLocal(new Date())}`);
      lines.push(`DTSTART:${dtStart}`);
      lines.push(`DTEND:${dtEnd}`);
      lines.push(`SUMMARY:${icsEscape(summary)}`);
      lines.push(`DESCRIPTION:${icsEscape(desc)}`);
      lines.push(`RRULE:FREQ=MONTHLY;BYMONTHDAY=${Number(b.dueDay)}`);
      lines.push("BEGIN:VALARM");
      lines.push(`TRIGGER:-PT${alarmMinutesBefore}M`);
      lines.push("ACTION:DISPLAY");
      lines.push(`DESCRIPTION:${icsEscape(summary)}`);
      lines.push("END:VALARM");
      lines.push("END:VEVENT");
    });

    lines.push("END:VCALENDAR");

    downloadTextFile("bills-reminders.ics", lines.join("\r\n"), "text/calendar;charset=utf-8");
    bills.forEach(b => b.calendarExported = true);
    save();
    renderAll();
    alert("Calendar file downloaded. Open it and add the events to your calendar.");
  }

  function doBackup(){
    const choice = prompt(
`Type:
1 to export backup
2 to import backup
3 to reset everything`,
"1"
    );
    if(choice === null) return;

    const c = choice.trim();
    if(c === "1"){
      const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      const stamp = new Date();
      const name = `bills-backup-${stamp.getFullYear()}-${pad2(stamp.getMonth()+1)}-${pad2(stamp.getDate())}.json`;
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
      alert("Backup downloaded. Save it somewhere safe.");
      return;
    }

    if(c === "2"){
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = async ()=>{
        const file = input.files && input.files[0];
        if(!file) return;
        const text = await file.text();
        try{
          const obj = migrateData(JSON.parse(text));
          state.data = obj;
          save();
          renderAll();
          alert("Import complete.");
        }catch(e){
          alert("Import failed. That file did not look like a valid backup.");
        }
      };
      input.click();
      return;
    }

    if(c === "3"){
      if(confirm("This wipes all data in this browser. Continue?")){
        state.data = defaultData();
        save();
        renderAll();
      }
      return;
    }
  }

  function renderSettings(){
    el.viewSettings.innerHTML = `
      <div class="card">
        <div class="row">
          <div>
            <div class="big">Settings</div>
            <div class="small muted">Tools, backup, and app info</div>
          </div>
          <button class="btn" id="closeSettings">Close</button>
        </div>
      </div>

      <div class="card">
        <div class="big">Tools</div>
        <div class="hr"></div>
        <div class="row">
          <button class="btn btnPurple" id="btnCalendar">Calendar export</button>
          <button class="btn" id="btnBackup">Backup</button>
        </div>
        <div class="small muted" style="margin-top:10px;">
          Calendar export downloads an .ics file for bills that have not been exported yet.
        </div>
      </div>

      <div class="card">
        <div class="big">About</div>
        <div class="hr"></div>
        <div class="small muted">Version: ${APP_VERSION}</div>
        <div class="small muted">Release date: ${RELEASE_DATE}</div>
        <div class="small muted">Developer: ${DEVELOPER}</div>
        <div class="small muted" style="margin-top:10px;">Model A local only. Data stays in this browser unless you export a backup.</div>
      </div>
    `;

    document.getElementById("closeSettings").addEventListener("click", ()=>{
      el.viewSettings.style.display = "none";
      // return to current tab view
      setTab(state.activeTab);
      renderAll();
    });

    document.getElementById("btnCalendar").addEventListener("click", exportBillsToCalendar);
    document.getElementById("btnBackup").addEventListener("click", doBackup);
  }

  function setTab(tab){
    state.activeTab = tab;
    el.tabTracker.classList.toggle("active", tab==="tracker");
    el.tabBills.classList.toggle("active", tab==="bills");
    el.tabHistory.classList.toggle("active", tab==="history");

    el.viewTracker.style.display = tab==="tracker" ? "" : "none";
    el.viewBills.style.display = tab==="bills" ? "" : "none";
    el.viewHistory.style.display = tab==="history" ? "" : "none";
    el.viewSettings.style.display = "none";
  }

  function renderAll(){
    setMetaLine();
    renderMonthSelect();
    if(state.activeTab==="tracker") renderTracker();
    if(state.activeTab==="bills") renderBills();
    if(state.activeTab==="history") renderHistory();
    if(state.activeTab!=="tracker"){
      updateStats(buildTrackerRows());
    }
  }

  // Month nav
  el.prevMonth.addEventListener("click", ()=>{
    state.monthKey = monthKeyFromDate(addMonths(firstOfMonthFromKey(state.monthKey), -1));
    renderAll();
  });
  el.nextMonth.addEventListener("click", ()=>{
    state.monthKey = monthKeyFromDate(addMonths(firstOfMonthFromKey(state.monthKey), 1));
    renderAll();
  });
  el.monthSelect.addEventListener("change", ()=>{
    state.monthKey = el.monthSelect.value;
    renderAll();
  });

  // Tabs
  el.tabTracker.addEventListener("click", ()=>{ setTab("tracker"); renderAll(); });
  el.tabBills.addEventListener("click", ()=>{ setTab("bills"); renderAll(); });
  el.tabHistory.addEventListener("click", ()=>{ setTab("history"); renderAll(); });

  // Settings
  el.btnSettings.addEventListener("click", ()=>{
    el.viewTracker.style.display = "none";
    el.viewBills.style.display = "none";
    el.viewHistory.style.display = "none";
    el.viewSettings.style.display = "";
    renderSettings();
  });

  // Initial
  save();      // ensures schema updates persist
  renderAll();
})();
</script>
</body>
</html>
