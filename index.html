<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bills Tracker</title>
  <style>
    :root{
      --bg:#151522;
      --card:#1c1c2b;
      --card2:#232337;
      --text:#f4f4f8;
      --muted:#c3c3d7;
      --purple:#c7a4ff;
      --purple2:#7a57cf;
      --danger:#ff5c6c;
      --ok:#35d98a;
      --line:rgba(255,255,255,0.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.28);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -30%, rgba(199,164,255,0.28), transparent 55%),
                  radial-gradient(1000px 700px at 90% 0%, rgba(122,87,207,0.22), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .app{
      max-width: 560px;
      margin: 0 auto;
      padding: 16px 14px 22px;
    }

    .top{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom: 12px;
    }
    .titleWrap{display:flex; flex-direction:column; gap:4px}
    .title{
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.2px;
      line-height: 1.1;
    }
    .slogan{
      font-size: 12px;
      color: var(--muted);
      font-style: italic;
      line-height: 1.2;
    }
    .topRight{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    .iconBtn{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      cursor:pointer;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .iconBtn:active{transform: scale(0.99)}
    .chip{
      font-size: 12px;
      font-weight: 800;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(199,164,255,0.16);
      border: 1px solid rgba(199,164,255,0.38);
      color: var(--text);
      white-space:nowrap;
      box-shadow: var(--shadow);
    }

    .monthRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin: 10px 0 12px;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 700;
      cursor:pointer;
      user-select:none;
      box-shadow: var(--shadow);
    }
    .btn:active{transform: scale(0.99)}
    .btnPurple{
      border:1px solid rgba(199,164,255,0.55);
      background: rgba(199,164,255,0.18);
    }
    .btnDanger{
      border:1px solid rgba(255,92,108,0.50);
      background: rgba(255,92,108,0.16);
    }
    .btnOk{
      border:1px solid rgba(53,217,138,0.50);
      background: rgba(53,217,138,0.14);
    }

    select, input, textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      outline:none;
    }
    input[type="month"]{
      padding: 9px 12px;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-bottom: 12px;
    }
    .stat{
      background: linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.04));
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
    }
    .stat .k{font-size:12px; color: var(--muted)}
    .stat .v{font-size:16px; font-weight:900; margin-top:4px}

    .seg{
      display:flex;
      gap:8px;
      background: rgba(255,255,255,0.05);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 6px;
      margin: 12px 0 12px;
      box-shadow: var(--shadow);
    }
    .seg button{
      flex:1;
      padding:10px 10px;
      border-radius: 14px;
      border:0;
      background: transparent;
      color: var(--muted);
      font-weight: 900;
      cursor:pointer;
    }
    .seg button.active{
      background: rgba(199,164,255,0.22);
      color: var(--text);
      border: 1px solid rgba(199,164,255,0.35);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.04));
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: var(--shadow);
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .muted{color: var(--muted)}
    .big{
      font-size: 16px;
      font-weight: 950;
    }
    .small{font-size: 12px}
    .pill{
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(199,164,255,0.16);
      border: 1px solid rgba(199,164,255,0.35);
      color: var(--text);
      white-space:nowrap;
    }
    .dueSoon{
      border-color: rgba(199,164,255,0.60);
      background: linear-gradient(180deg, rgba(199,164,255,0.18), rgba(255,255,255,0.04));
    }
    .overdue{
      border-color: rgba(255,92,108,0.60);
      background: linear-gradient(180deg, rgba(255,92,108,0.16), rgba(255,255,255,0.04));
    }
    .paidFade{opacity:0.80}
    .toggle{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      white-space:nowrap;
    }
    .checkbox{
      width:22px;
      height:22px;
      accent-color: var(--purple);
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .hr{
      height:1px;
      background: var(--line);
      margin: 10px 0;
    }
    .footerNote{
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    a{color: var(--purple); text-decoration:none}

    .kbd{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      font-weight: 800;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="titleWrap">
        <div class="title">Bills Tracker</div>
        <div class="slogan">Because forgetting costs money</div>
      </div>
      <div class="topRight">
        <div class="chip" id="chipMonth">Month</div>
        <button class="iconBtn" id="btnSettings" aria-label="Settings" title="Settings">
          <!-- simple gear -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/>
            <path d="M19.4 15a7.9 7.9 0 0 0 .1-1l2-1.2-2-3.4-2.3.7a8 8 0 0 0-1.7-1L15 6.8h-4l-.5 2.3a8 8 0 0 0-1.7 1L6.5 9.4l-2 3.4 2 1.2a8 8 0 0 0 .1 1 8 8 0 0 0-.1 1l-2 1.2 2 3.4 2.3-.7a8 8 0 0 0 1.7 1l.5 2.3h4l.5-2.3a8 8 0 0 0 1.7-1l2.3.7 2-3.4-2-1.2a7.9 7.9 0 0 0-.1-1Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="monthRow">
      <button class="btn" id="prevMonth">◀︎</button>
      <select id="monthSelect" aria-label="Month selector"></select>
      <button class="btn" id="nextMonth">▶︎</button>
    </div>

    <div class="stats">
      <div class="stat"><div class="k">Total due</div><div class="v" id="statDue">$0.00</div></div>
      <div class="stat"><div class="k">Paid</div><div class="v" id="statPaid">$0.00</div></div>
      <div class="stat"><div class="k">Unpaid</div><div class="v" id="statUnpaid">$0.00</div></div>
    </div>

    <div class="seg" id="tabsBar">
      <button id="tabTracker" class="active">Tracker</button>
      <button id="tabBills">Bills</button>
      <button id="tabHistory">History</button>
    </div>

    <div id="viewTracker"></div>
    <div id="viewBills" style="display:none;"></div>
    <div id="viewHistory" style="display:none;"></div>
    <div id="viewSettings" style="display:none;"></div>

    <div class="footerNote">
      Model A local only. Data stays in this browser. Use Settings for Backup.
    </div>
  </div>

<script>
(function(){
  const APP_VERSION = "1.5";
  const RELEASE_DATE = "2025-12-27";
  const DEVELOPER = "Manny Ch.";
  const STORAGE_KEY = "billTrackerV15";

  const today = () => {
    const d = new Date();
    d.setHours(0,0,0,0);
    return d;
  };

  const fmtMoney = (n) => {
    return new Intl.NumberFormat(undefined, {style:"currency", currency:"USD"}).format(Number(n || 0));
  };

  const pad2 = (n) => String(n).padStart(2,"0");

  const toISODate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

  const monthKeyFromDate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;

  const monthLabelFromKey = (key) => {
    const [y,m] = key.split("-").map(Number);
    const dt = new Date(y, m-1, 1);
    return dt.toLocaleString(undefined, {month:"short", year:"numeric"});
  };

  const addMonthsDate = (d, delta) => {
    const dt = new Date(d.getFullYear(), d.getMonth()+delta, 1);
    dt.setHours(0,0,0,0);
    return dt;
  };

  const addMonthsKey = (monthKey, delta) => {
    const [y,m] = monthKey.split("-").map(Number);
    const dt = new Date(y, m-1+delta, 1);
    return monthKeyFromDate(dt);
  };

  const firstOfMonthFromKey = (key) => {
    const [y,m] = key.split("-").map(Number);
    const dt = new Date(y, m-1, 1);
    dt.setHours(0,0,0,0);
    return dt;
  };

  const computeDueDate = (monthKey, dueDay) => {
    const base = firstOfMonthFromKey(monthKey);
    const y = base.getFullYear();
    const m = base.getMonth();
    const lastDay = new Date(y, m+1, 0).getDate();
    const day = Math.min(Number(dueDay), lastDay);
    const dt = new Date(y, m, day);
    dt.setHours(0,0,0,0);
    return dt;
  };

  const daysBetween = (a,b) => {
    const ms = 24*60*60*1000;
    return Math.floor((b.getTime() - a.getTime())/ms);
  };

  const uid = () => Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,10);

  function defaultData(){
    return {
      bills: [],
      payments: {},
      notes: {}
    };
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultData();
      const data = JSON.parse(raw);
      if(!data || !Array.isArray(data.bills)) return defaultData();
      data.payments ||= {};
      data.notes ||= {};
      data.bills.forEach(b => {
        if (b.calendarExported === undefined) b.calendarExported = false;
        if (b.startMonth === undefined) b.startMonth = "";
        if (b.endMonth === undefined) b.endMonth = "";
      });
      return data;
    }catch(e){
      return defaultData();
    }
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
  }

  const state = {
    data: load(),
    monthKey: monthKeyFromDate(today()),
    activeView: "main",   // "main" or "settings"
    activeTab: "tracker", // tracker, bills, history
  };

  const el = {
    chipMonth: document.getElementById("chipMonth"),
    monthSelect: document.getElementById("monthSelect"),
    prevMonth: document.getElementById("prevMonth"),
    nextMonth: document.getElementById("nextMonth"),
    statDue: document.getElementById("statDue"),
    statPaid: document.getElementById("statPaid"),
    statUnpaid: document.getElementById("statUnpaid"),
    tabsBar: document.getElementById("tabsBar"),
    tabTracker: document.getElementById("tabTracker"),
    tabBills: document.getElementById("tabBills"),
    tabHistory: document.getElementById("tabHistory"),
    viewTracker: document.getElementById("viewTracker"),
    viewBills: document.getElementById("viewBills"),
    viewHistory: document.getElementById("viewHistory"),
    viewSettings: document.getElementById("viewSettings"),
    btnSettings: document.getElementById("btnSettings"),
  };

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

  function monthOptions(){
    const now = today();
    const start = addMonthsDate(new Date(now.getFullYear(), now.getMonth(), 1), -12);
    const end = addMonthsDate(new Date(now.getFullYear(), now.getMonth(), 1), 24);
    const keys = [];
    let cur = new Date(start);
    while(cur <= end){
      keys.push(monthKeyFromDate(cur));
      cur = addMonthsDate(cur, 1);
    }
    return keys;
  }

  function renderMonthSelect(){
    const keys = monthOptions();
    el.monthSelect.innerHTML = keys.map(k => `<option value="${k}">${monthLabelFromKey(k)}</option>`).join("");
    el.monthSelect.value = state.monthKey;
    el.chipMonth.textContent = monthLabelFromKey(state.monthKey);
  }

  function getInstanceKey(monthKey, billId){
    return `${monthKey}|${billId}`;
  }

  function isPaid(monthKey, billId){
    return Boolean(state.data.payments[getInstanceKey(monthKey, billId)]);
  }

  function paidInfo(monthKey, billId){
    return state.data.payments[getInstanceKey(monthKey, billId)] || null;
  }

  function setPaid(monthKey, bill){
    const k = getInstanceKey(monthKey, bill.id);
    const due = computeDueDate(monthKey, bill.dueDay);
    state.data.payments[k] = {
      paidAtISO: toISODate(today()),
      dueISO: toISODate(due),
      amount: Number(bill.amount || 0)
    };
    save();
  }

  function setUnpaid(monthKey, billId){
    const k = getInstanceKey(monthKey, billId);
    delete state.data.payments[k];
    save();
  }

  function getNote(monthKey, billId){
    return state.data.notes[getInstanceKey(monthKey, billId)] || "";
  }

  function setNote(monthKey, billId, text){
    const k = getInstanceKey(monthKey, billId);
    if(text && text.trim()){
      state.data.notes[k] = text.trim();
    }else{
      delete state.data.notes[k];
    }
    save();
  }

  function monthKeyCompare(a,b){
    // a and b are "YYYY-MM"
    if(a === b) return 0;
    return a < b ? -1 : 1;
  }

  function billAppliesToMonth(bill, monthKey){
    if(bill.active === false) return false;

    const start = (bill.startMonth || "").trim();
    const end = (bill.endMonth || "").trim();

    if(start && monthKeyCompare(monthKey, start) < 0) return false;
    if(end && monthKeyCompare(monthKey, end) > 0) return false;
    return true;
  }

  function activeBillsForMonth(monthKey){
    return state.data.bills.filter(b => billAppliesToMonth(b, monthKey));
  }

  function scheduleLabel(bill){
    const start = (bill.startMonth || "").trim();
    const end = (bill.endMonth || "").trim();
    if(!start && !end) return "";
    if(start && end) return `Schedule: ${start} to ${end}`;
    if(start && !end) return `Schedule: starts ${start}`;
    if(!start && end) return `Schedule: ends ${end}`;
    return "";
  }

  function buildTrackerRows(){
    const bills = activeBillsForMonth(state.monthKey);
    const rows = bills.map(b => {
      const dueDate = computeDueDate(state.monthKey, b.dueDay);
      const paid = isPaid(state.monthKey, b.id);
      const info = paid ? paidInfo(state.monthKey, b.id) : null;
      const note = getNote(state.monthKey, b.id);
      return {
        bill: b,
        dueDate,
        dueISO: toISODate(dueDate),
        paid,
        paidAtISO: info ? info.paidAtISO : null,
        note
      };
    });
    rows.sort((a,b) => a.dueDate - b.dueDate || a.bill.provider.localeCompare(b.bill.provider));
    return rows;
  }

  function updateStats(rows){
    const totalDue = rows.reduce((s,r)=> s + Number(r.bill.amount||0), 0);
    const totalPaid = rows.filter(r=>r.paid).reduce((s,r)=> s + Number(r.bill.amount||0), 0);
    const totalUnpaid = totalDue - totalPaid;
    el.statDue.textContent = fmtMoney(totalDue);
    el.statPaid.textContent = fmtMoney(totalPaid);
    el.statUnpaid.textContent = fmtMoney(totalUnpaid);
  }

  function renderTracker(){
    const rows = buildTrackerRows();
    updateStats(rows);

    const now = today();
    if(rows.length === 0){
      el.viewTracker.innerHTML = `
        <div class="card">
          <div class="big">Nothing scheduled for ${escapeHtml(monthLabelFromKey(state.monthKey))}</div>
          <div class="small muted" style="margin-top:6px;">
            Go to the Bills tab and add your first bill.
          </div>
        </div>
      `;
      return;
    }

    el.viewTracker.innerHTML = rows.map(r => {
      const dueIn = daysBetween(now, r.dueDate);
      const overdue = !r.paid && r.dueDate < now;
      const dueSoon = !r.paid && r.dueDate >= now && dueIn <= 7;

      const cls = [
        "card",
        dueSoon ? "dueSoon" : "",
        overdue ? "overdue" : "",
        r.paid ? "paidFade" : ""
      ].filter(Boolean).join(" ");

      const paidLabel = r.paid ? `Paid ${r.paidAtISO}` : "Unpaid";
      const noteLine = r.note ? `<div class="small muted" style="margin-top:6px;">Note: ${escapeHtml(r.note)}</div>` : "";
      const sched = scheduleLabel(r.bill);
      const schedLine = sched ? `<div class="small muted" style="margin-top:6px;">${escapeHtml(sched)}</div>` : "";

      return `
        <div class="${cls}">
          <div class="row">
            <div>
              <div class="small muted">Due ${r.dueISO}</div>
              <div class="big">${escapeHtml(r.bill.provider)}</div>
              ${schedLine}
            </div>
            <div class="toggle">
              <div style="text-align:right;">
                <div class="big">${fmtMoney(r.bill.amount)}</div>
                <div class="small muted">${paidLabel}</div>
              </div>
              <input class="checkbox" type="checkbox" ${r.paid ? "checked" : ""} data-billid="${r.bill.id}" />
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="pill">${escapeHtml(r.bill.category)}</div>
            <button class="btn" data-note="${r.bill.id}">Note</button>
          </div>
          ${noteLine}
        </div>
      `;
    }).join("");

    el.viewTracker.querySelectorAll('input[type="checkbox"][data-billid]').forEach(cb => {
      cb.addEventListener("change", (e) => {
        const billId = e.target.getAttribute("data-billid");
        const bill = state.data.bills.find(b => b.id === billId);
        if(!bill) return;
        if(e.target.checked){
          setPaid(state.monthKey, bill);
        }else{
          setUnpaid(state.monthKey, billId);
        }
        renderAll();
      });
    });

    el.viewTracker.querySelectorAll('button[data-note]').forEach(btn => {
      btn.addEventListener("click", () => {
        const billId = btn.getAttribute("data-note");
        const current = getNote(state.monthKey, billId);
        const text = prompt("Note for this month and this bill", current);
        if(text === null) return;
        setNote(state.monthKey, billId, text);
        renderAll();
      });
    });
  }

  function renderBills(){
    const bills = state.data.bills.slice().sort((a,b)=>
      (a.active===b.active?0:(a.active? -1:1)) ||
      a.provider.localeCompare(b.provider)
    );

    el.viewBills.innerHTML = `
      <div class="card">
        <div class="row">
          <div>
            <div class="big">Bills Master</div>
            <div class="small muted">Add or edit recurring bills</div>
          </div>
          <button class="btn btnPurple" id="addBill">Add</button>
        </div>
      </div>

      ${bills.length === 0 ? `
        <div class="card">
          <div class="muted">No bills yet. Hit Add to create one.</div>
        </div>
      ` : bills.map(b => {
        const sched = scheduleLabel(b);
        return `
          <div class="card">
            <div class="row">
              <div>
                <div class="big">${escapeHtml(b.provider)}</div>
                <div class="small muted">
                  ${escapeHtml(b.category)} · Due day ${Number(b.dueDay)} · ${fmtMoney(b.amount)}
                </div>
                ${sched ? `<div class="small muted" style="margin-top:6px;">${escapeHtml(sched)}</div>` : ``}
              </div>
              <div class="toggle">
                <label class="small muted">Active</label>
                <input class="checkbox" type="checkbox" ${b.active !== false ? "checked" : ""} data-active="${b.id}" />
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <button class="btn" data-edit="${b.id}">Edit</button>
              <button class="btn btnDanger" data-del="${b.id}">Delete</button>
            </div>
          </div>
        `;
      }).join("")}
    `;

    document.getElementById("addBill").addEventListener("click", () => editBill(null));

    el.viewBills.querySelectorAll('input[type="checkbox"][data-active]').forEach(cb => {
      cb.addEventListener("change", (e) => {
        const id = e.target.getAttribute("data-active");
        const bill = state.data.bills.find(x => x.id === id);
        if(!bill) return;
        bill.active = e.target.checked;
        save();
        renderAll();
      });
    });

    el.viewBills.querySelectorAll('button[data-edit]').forEach(btn => {
      btn.addEventListener("click", () => editBill(btn.getAttribute("data-edit")));
    });

    el.viewBills.querySelectorAll('button[data-del]').forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        const bill = state.data.bills.find(x => x.id === id);
        if(!bill) return;
        if(confirm(`Delete bill: ${bill.provider}?`)){
          state.data.bills = state.data.bills.filter(x => x.id !== id);
          for(const k of Object.keys(state.data.payments)){
            if(k.endsWith("|"+id)) delete state.data.payments[k];
          }
          for(const k of Object.keys(state.data.notes)){
            if(k.endsWith("|"+id)) delete state.data.notes[k];
          }
          save();
          renderAll();
        }
      });
    });
  }

  function normalizeMonthInput(s){
    const v = (s || "").trim();
    if(!v) return "";
    // expects "YYYY-MM"
    if(!/^\d{4}-\d{2}$/.test(v)) return "";
    return v;
  }

  function computeEndMonthFromDuration(startMonth, durationMonths){
    const dur = Number(durationMonths);
    if(!startMonth || !Number.isFinite(dur) || dur <= 0) return "";
    return addMonthsKey(startMonth, dur - 1);
  }

  function editBill(id){
    const isNew = !id;
    const existing = isNew ? null : state.data.bills.find(b=>b.id===id);

    const bill = isNew
      ? {id: uid(), category:"Subscriptions", provider:"", dueDay:1, amount:0, active:true, startMonth:"", endMonth:""}
      : JSON.parse(JSON.stringify(existing));

    if(!bill) return;

    const formHtml = `
      <div class="card">
        <div class="row">
          <div class="big">${isNew ? "Add bill" : "Edit bill"}</div>
          <span class="pill">v${escapeHtml(APP_VERSION)}</span>
        </div>
        <div class="hr"></div>

        <div style="display:grid; gap:10px;">
          <div>
            <div class="small muted" style="margin:0 0 6px;">Provider</div>
            <input id="fProvider" value="${escapeAttr(bill.provider)}" placeholder="Netflix" />
          </div>

          <div class="grid2">
            <div>
              <div class="small muted" style="margin:0 0 6px;">Category</div>
              <input id="fCategory" value="${escapeAttr(bill.category)}" placeholder="Subscriptions" />
            </div>
            <div>
              <div class="small muted" style="margin:0 0 6px;">Due day</div>
              <input id="fDueDay" type="number" min="1" max="31" value="${Number(bill.dueDay)}" />
            </div>
          </div>

          <div class="grid2">
            <div>
              <div class="small muted" style="margin:0 0 6px;">Amount</div>
              <input id="fAmount" type="number" step="0.01" value="${Number(bill.amount)}" />
            </div>
            <div>
              <div class="small muted" style="margin:0 0 6px;">Active</div>
              <select id="fActive">
                <option value="true" ${bill.active!==false ? "selected":""}>True</option>
                <option value="false" ${bill.active===false ? "selected":""}>False</option>
              </select>
            </div>
          </div>

          <div class="card" style="margin:0;">
            <div class="big" style="font-size:14px;">Schedule</div>
            <div class="small muted" style="margin-top:6px;">Optional. Use this for promos, payment plans, or anything with a start and end.</div>
            <div class="hr"></div>

            <div class="grid3">
              <div>
                <div class="small muted" style="margin:0 0 6px;">Start month</div>
                <input id="fStartMonth" type="month" value="${escapeAttr(bill.startMonth || "")}" />
              </div>
              <div>
                <div class="small muted" style="margin:0 0 6px;">Duration, months</div>
                <input id="fDuration" type="number" min="1" step="1" placeholder="Optional" />
              </div>
              <div>
                <div class="small muted" style="margin:0 0 6px;">End month</div>
                <input id="fEndMonth" type="month" value="${escapeAttr(bill.endMonth || "")}" />
              </div>
            </div>

            <div class="small muted" style="margin-top:10px;">
              Tip: If you fill Start month and Duration, the app will auto set End month.
            </div>
          </div>

          <div class="row">
            <button class="btn btnDanger" id="cancelEdit">Cancel</button>
            <button class="btn btnOk" id="saveEdit">Save</button>
          </div>
        </div>
      </div>
    `;

    el.viewBills.innerHTML = formHtml;

    // Auto fill end month when duration changes
    const durationEl = document.getElementById("fDuration");
    durationEl.addEventListener("input", () => {
      const start = normalizeMonthInput(document.getElementById("fStartMonth").value);
      const end = computeEndMonthFromDuration(start, durationEl.value);
      if(end){
        document.getElementById("fEndMonth").value = end;
      }
    });

    document.getElementById("cancelEdit").addEventListener("click", () => renderAll());

    document.getElementById("saveEdit").addEventListener("click", () => {
      const provider = document.getElementById("fProvider").value.trim();
      const category = document.getElementById("fCategory").value.trim();
      const dueDay = Number(document.getElementById("fDueDay").value);
      const amount = Number(document.getElementById("fAmount").value);
      const active = document.getElementById("fActive").value === "true";

      const startMonth = normalizeMonthInput(document.getElementById("fStartMonth").value);
      let endMonth = normalizeMonthInput(document.getElementById("fEndMonth").value);
      const duration = Number(durationEl.value);

      if(startMonth && !endMonth && Number.isFinite(duration) && duration > 0){
        endMonth = computeEndMonthFromDuration(startMonth, duration);
      }

      if(endMonth && !startMonth){
        alert("If you set an End month, you also need a Start month.");
        return;
      }
      if(startMonth && endMonth && monthKeyCompare(endMonth, startMonth) < 0){
        alert("End month must be the same or later than Start month.");
        return;
      }

      if(!provider){
        alert("Provider is required.");
        return;
      }
      if(!category){
        alert("Category is required.");
        return;
      }
      if(!Number.isFinite(dueDay) || dueDay < 1 || dueDay > 31){
        alert("Due day must be 1 to 31.");
        return;
      }
      if(!Number.isFinite(amount) || amount < 0){
        alert("Amount must be 0 or more.");
        return;
      }

      const newBill = {
        ...bill,
        provider,
        category,
        dueDay,
        amount,
        active,
        startMonth,
        endMonth
      };

      if(isNew){
        state.data.bills.push(newBill);
      }else{
        const idx = state.data.bills.findIndex(b=>b.id===id);
        if(idx >= 0) state.data.bills[idx] = newBill;
      }
      save();
      renderAll();
    });
  }

  function renderHistory(){
    const items = [];
    for(const k of Object.keys(state.data.payments)){
      const [monthKey, billId] = k.split("|");
      if(monthKey !== state.monthKey) continue;
      const bill = state.data.bills.find(b=>b.id===billId);
      const info = state.data.payments[k];
      if(!bill || !info) continue;
      items.push({
        provider: bill.provider,
        category: bill.category,
        amount: info.amount,
        paidAtISO: info.paidAtISO,
        dueISO: info.dueISO,
        billId
      });
    }
    items.sort((a,b)=> (a.paidAtISO < b.paidAtISO ? 1 : -1) || a.provider.localeCompare(b.provider));

    el.viewHistory.innerHTML = `
      <div class="card">
        <div class="big">History</div>
        <div class="small muted">Paid entries for ${escapeHtml(monthLabelFromKey(state.monthKey))}</div>
      </div>

      ${items.length === 0 ? `
        <div class="card">
          <div class="muted">No payments logged for this month yet.</div>
        </div>
      ` : items.map(it => `
        <div class="card">
          <div class="row">
            <div>
              <div class="small muted">Paid ${escapeHtml(it.paidAtISO)}</div>
              <div class="big">${escapeHtml(it.provider)}</div>
              <div class="small muted">For due date ${escapeHtml(it.dueISO)}</div>
            </div>
            <div style="text-align:right;">
              <div class="big">${fmtMoney(it.amount)}</div>
              <div class="pill">${escapeHtml(it.category)}</div>
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn btnDanger" data-undo="${it.billId}">Undo</button>
          </div>
        </div>
      `).join("")}
    `;

    el.viewHistory.querySelectorAll('button[data-undo]').forEach(btn => {
      btn.addEventListener("click", () => {
        const billId = btn.getAttribute("data-undo");
        if(confirm("Mark unpaid for this month?")){
          setUnpaid(state.monthKey, billId);
          renderAll();
        }
      });
    });
  }

  function setTab(tab){
    state.activeTab = tab;
    el.tabTracker.classList.toggle("active", tab === "tracker");
    el.tabBills.classList.toggle("active", tab === "bills");
    el.tabHistory.classList.toggle("active", tab === "history");

    el.viewTracker.style.display = (tab === "tracker" && state.activeView === "main") ? "" : "none";
    el.viewBills.style.display = (tab === "bills" && state.activeView === "main") ? "" : "none";
    el.viewHistory.style.display = (tab === "history" && state.activeView === "main") ? "" : "none";
  }

  function showMain(){
    state.activeView = "main";
    el.tabsBar.style.display = "";
    el.viewSettings.style.display = "none";
    setTab(state.activeTab);
    renderAll();
  }

  function showSettings(){
    state.activeView = "settings";
    el.tabsBar.style.display = "none";
    el.viewTracker.style.display = "none";
    el.viewBills.style.display = "none";
    el.viewHistory.style.display = "none";
    el.viewSettings.style.display = "";
    renderSettings();
  }

  function downloadTextFile(filename, content, mime){
    const blob = new Blob([content], {type: mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
  }

  function doBackupExport(){
    const stamp = new Date();
    const name = `bills-backup-${stamp.getFullYear()}-${pad2(stamp.getMonth()+1)}-${pad2(stamp.getDate())}.json`;
    downloadTextFile(name, JSON.stringify(state.data, null, 2), "application/json;charset=utf-8");
    alert("Backup downloaded. Save it somewhere safe, like iCloud Drive.");
  }

  function doBackupImport(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async () => {
      const file = input.files && input.files[0];
      if(!file) return;
      const text = await file.text();
      try{
        const obj = JSON.parse(text);
        if(!obj || !Array.isArray(obj.bills)) throw new Error("Invalid file");
        obj.payments ||= {};
        obj.notes ||= {};
        obj.bills.forEach(b => {
          if (b.calendarExported === undefined) b.calendarExported = false;
          if (b.startMonth === undefined) b.startMonth = "";
          if (b.endMonth === undefined) b.endMonth = "";
        });
        state.data = obj;
        save();
        renderAll();
        alert("Import complete.");
      }catch(e){
        alert("Import failed. That file did not look like a valid backup.");
      }
    };
    input.click();
  }

  function doResetAll(){
    if(confirm("This wipes all data in this browser. Continue?")){
      state.data = defaultData();
      save();
      renderAll();
      alert("Reset complete.");
    }
  }

  function icsEscape(s){
    return String(s ?? "")
      .replace(/\\/g, "\\\\")
      .replace(/\n/g, "\\n")
      .replace(/,/g, "\\,")
      .replace(/;/g, "\\;");
  }

  function formatICSDateTimeLocal(d){
    const y = d.getFullYear();
    const m = pad2(d.getMonth()+1);
    const day = pad2(d.getDate());
    const hh = pad2(d.getHours());
    const mm = pad2(d.getMinutes());
    const ss = pad2(d.getSeconds());
    return `${y}${m}${day}T${hh}${mm}${ss}`;
  }

  function exportBillsToCalendar(){
    const bills = activeBillsForMonth(state.monthKey).filter(b => !b.calendarExported);
    if(bills.length === 0){
      alert("No bills to export for this month, or they have already been exported.");
      return;
    }

    const startMonth = firstOfMonthFromKey(state.monthKey);
    const reminderHour = 9;
    const reminderMinute = 0;
    const alarmMinutesBefore = 24 * 60;

    const lines = [];
    lines.push("BEGIN:VCALENDAR");
    lines.push("VERSION:2.0");
    lines.push("PRODID:-//BillsTracker//EN");
    lines.push("CALSCALE:GREGORIAN");
    lines.push("METHOD:PUBLISH");

    bills.forEach(b => {
      const due = computeDueDate(monthKeyFromDate(startMonth), b.dueDay);
      const dt = new Date(due.getFullYear(), due.getMonth(), due.getDate(), reminderHour, reminderMinute, 0);
      const dtStart = formatICSDateTimeLocal(dt);
      const dtEnd = formatICSDateTimeLocal(new Date(dt.getTime() + 30 * 60000));

      const uidStr = `${b.id}@billstracker`;
      const summary = `${b.provider} due`;
      const desc = `${b.category}. Amount: ${fmtMoney(b.amount)}. Due day: ${b.dueDay}.`;

      lines.push("BEGIN:VEVENT");
      lines.push(`UID:${icsEscape(uidStr)}`);
      lines.push(`DTSTAMP:${formatICSDateTimeLocal(new Date())}`);
      lines.push(`DTSTART:${dtStart}`);
      lines.push(`DTEND:${dtEnd}`);
      lines.push(`SUMMARY:${icsEscape(summary)}`);
      lines.push(`DESCRIPTION:${icsEscape(desc)}`);
      lines.push(`RRULE:FREQ=MONTHLY;BYMONTHDAY=${Number(b.dueDay)}`);

      lines.push("BEGIN:VALARM");
      lines.push(`TRIGGER:-PT${alarmMinutesBefore}M`);
      lines.push("ACTION:DISPLAY");
      lines.push(`DESCRIPTION:${icsEscape(summary)}`);
      lines.push("END:VALARM");

      lines.push("END:VEVENT");
    });

    lines.push("END:VCALENDAR");

    downloadTextFile("bills-reminders.ics", lines.join("\r\n"), "text/calendar;charset=utf-8");

    bills.forEach(b => b.calendarExported = true);
    save();
    renderAll();

    alert("Calendar file downloaded. Open it and add the events to your calendar.");
  }

  function renderSettings(){
    el.viewSettings.innerHTML = `
      <div class="card">
        <div class="row">
          <div>
            <div class="big">Settings</div>
            <div class="small muted">Backup, calendar export, and app info</div>
          </div>
          <button class="btn btnPurple" id="btnBackMain">Back</button>
        </div>
      </div>

      <div class="card">
        <div class="big" style="font-size:14px;">Tools</div>
        <div class="hr"></div>
        <div class="grid2">
          <button class="btn btnPurple" id="btnCalendarExport">Export calendar reminders</button>
          <button class="btn" id="btnCalendarReset">Allow re export</button>
        </div>
        <div class="small muted" style="margin-top:10px;">
          Export creates an <span class="kbd">.ics</span> file. Import it into your calendar.
        </div>
      </div>

      <div class="card">
        <div class="big" style="font-size:14px;">Backup</div>
        <div class="hr"></div>
        <div class="grid2">
          <button class="btn btnPurple" id="btnBackupExport">Export backup</button>
          <button class="btn" id="btnBackupImport">Import backup</button>
        </div>
        <div class="small muted" style="margin-top:10px;">
          Backups are JSON files. Keep them somewhere safe.
        </div>
      </div>

      <div class="card">
        <div class="big" style="font-size:14px;">Danger zone</div>
        <div class="hr"></div>
        <button class="btn btnDanger" id="btnResetAll">Reset everything</button>
        <div class="small muted" style="margin-top:10px;">
          This wipes bills, notes, and history from this browser only.
        </div>
      </div>

      <div class="card">
        <div class="big" style="font-size:14px;">About</div>
        <div class="hr"></div>
        <div class="small muted">Version</div>
        <div class="big" style="margin-top:4px;">v${escapeHtml(APP_VERSION)}</div>

        <div class="hr"></div>

        <div class="small muted">Release date</div>
        <div class="big" style="margin-top:4px;">${escapeHtml(RELEASE_DATE)}</div>

        <div class="hr"></div>

        <div class="small muted">Developer</div>
        <div class="big" style="margin-top:4px;">${escapeHtml(DEVELOPER)}</div>
      </div>
    `;

    document.getElementById("btnBackMain").addEventListener("click", showMain);

    document.getElementById("btnCalendarExport").addEventListener("click", exportBillsToCalendar);

    document.getElementById("btnCalendarReset").addEventListener("click", () => {
      if(state.data.bills.length === 0){
        alert("No bills yet.");
        return;
      }
      if(confirm("Mark all bills as not exported, so they can be exported again?")){
        state.data.bills.forEach(b => b.calendarExported = false);
        save();
        alert("Done. Calendar export is available again.");
      }
    });

    document.getElementById("btnBackupExport").addEventListener("click", doBackupExport);
    document.getElementById("btnBackupImport").addEventListener("click", doBackupImport);
    document.getElementById("btnResetAll").addEventListener("click", doResetAll);
  }

  function renderAll(){
    renderMonthSelect();

    if(state.activeView === "settings"){
      renderSettings();
      return;
    }

    if(state.activeTab === "tracker") renderTracker();
    if(state.activeTab === "bills") renderBills();
    if(state.activeTab === "history") renderHistory();

    if(state.activeTab !== "tracker"){
      const rows = buildTrackerRows();
      updateStats(rows);
    }
  }

  // Events
  el.prevMonth.addEventListener("click", () => {
    state.monthKey = addMonthsKey(state.monthKey, -1);
    renderAll();
  });

  el.nextMonth.addEventListener("click", () => {
    state.monthKey = addMonthsKey(state.monthKey, 1);
    renderAll();
  });

  el.monthSelect.addEventListener("change", () => {
    state.monthKey = el.monthSelect.value;
    renderAll();
  });

  el.tabTracker.addEventListener("click", () => { setTab("tracker"); renderAll(); });
  el.tabBills.addEventListener("click", () => { setTab("bills"); renderAll(); });
  el.tabHistory.addEventListener("click", () => { setTab("history"); renderAll(); });

  el.btnSettings.addEventListener("click", () => {
    if(state.activeView === "settings") showMain();
    else showSettings();
  });

  // Initial render
  renderAll();
})();
</script>
</body>
</html>
